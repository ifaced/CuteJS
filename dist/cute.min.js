/*! DOM Template Engine - v0.0.1 - 2012-08-29
* https://github.com/ifaced/cutejs
* Copyright (c) 2012 Interfaced; Licensed MIT */
var cuteJS={};cuteJS.Engine=function(){var a="cuteJS.",b=function(){this._input=new c,this._output=new c,this._analyzer=new d(this._input),this._initializeParsing()};b.prototype.register=function(a,b,c){this._clearHolders();var d=this._buildRawBody(b),e=this._buildExportFunction(),f=this._input.getTypedef(),g=this._compileTemplateFunctionBody(d,e),h=new Function("options",g);f?c[a]=function(a,b){return h.call(a,b)}:c[a]=h},b.prototype.compile=function(b,c,d){this._clearHolders();var e=this._buildRawBody(c),f=this._buildExportFunction(),g=this._input.getTypedef(),h=this._output.getTypedef(),i=this._getNNN(d+"."+b),j=this._compileTemplateFunctionBody(e,f,i.outName),k="",l=this._analyzer.getInputType();return l?(k+="/** @typedef {"+l+"} */\n",k+=i.inName+";\n"):g&&(k+="/**\n * @typedef {"+g.split("\n").join("\n * ")+"}\n */\n",k+=i.inName+";\n"),k+="/**\n * @typedef {"+h.split("\n").join("\n * ")+"}\n */\n",k+=i.outName+";\n",k+="/**\n",g&&(k+=" * @param {"+i.inName+"} data\n"),k+=" * @param {?"+a+"TemplateOptions} [options]\n",k+=" * @return {"+i.outName+"}\n",k+=" */\n",g?(k+=d+"."+b+" = function(data, options) {\n",k+="\t/**\n",k+="\t * @this {"+i.inName+"}\n",k+="\t * @return {"+i.outName+"}\n",k+="\t */\n",k+="\tvar _template = function() {\n",j=j.split("\n").join("\n\t\t"),k+="\t\t"+j+"\n",k+="\t};\n",k+="\treturn _template.call(data);\n",k+="};"):(j=j.split("\n").join("\n\t"),k+=d+"."+b+" = function(options) {\n",k+="\t"+j+"\n",k+="};"),k},b.prototype._compileTemplateFunctionBody=function(b,c,d){var e="var templatesData = {};\n";return d&&(e+="/**\n",e+=" * @param {string} key\n",e+=" * @param {"+d+"} exports\n",e+=" * @param {*} value\n",e+=" */\n"),e+=c+"\n",e+=b+"\n",e+="return "+a+"buildResult(__p, templatesData, exportFunction, options);",e},b.prototype._initializeParsing=function(){this._templateHandlers={typedef:[/\{\{\*([\s\S]+?)\}\}\s*/g,this._replaceTypedef.bind(this)],escaper:[/\\|'|\r|\n|\t|\u2028|\u2029/g,this._replaceEscaper.bind(this)],interpolate:[/\{\{=([\s\S]+?)\}\}/g,this._replaceInterpolate.bind(this)],escape:[/\{\{-([\s\S]+?)\}\}/g,this._replaceEscape.bind(this)],partial:[/\{\{#([\s\S]+?)\}\}/g,this._replacePartial.bind(this)],component:[/\{\{%([\s\S]+?)\}\}/g,this._replaceComponent.bind(this)],exportNode:[/<([a-z]+)[^>]*\sdata-export-id\s*=\s*(["'])?\{\{@\s*([a-z][a-z0-9]*(\[\])?)\s*\}\}\2[^>]*>/gi,this._replaceExport.bind(this)],evaluate:[/\{\{([\s\S]+?)\}\}/g,this._replaceEvaluate.bind(this)]},this._escapes={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var a in this._escapes)this._escapes.hasOwnProperty(a)&&(this._escapes[this._escapes[a]]=a)},b.prototype._buildRawBody=function(a){this._output.addVariable("root","DocumentFragment");var b="var __p='';\n";b+="__p+='";for(var c in this._templateHandlers)if(this._templateHandlers.hasOwnProperty(c)){var d=this._templateHandlers[c];a=a.replace(d[0],d[1])}return b+=a+"';\n",this._analyzer.commitPredefined(),b},b.prototype._buildExportFunction=function(){var a="";if(this._output.hasVariables()){a+="var exportFunction = function(value, key, exports) {\n",a+='\tvar errMessage = "Include name is already defined: " + key;\n',a+="\tswitch (key) {\n";var b=this._output.getVariables();for(var c in b)if(b.hasOwnProperty(c)){var d=b[c],e=/^Array\./,f=e.test(d);c=c.replace(e,""),a+='\t\tcase "'+c+'":\n',f?a+="\t\t\texports."+c+" = exports."+c+" || [];\n"+"\t\t\t"+"exports."+c+".push(value);\n":a+="\t\t\tif( !exports."+c+" ) {\n"+"\t\t\t\t"+"exports."+c+" = value;\n"+"\t\t\t"+"} else {\n"+"\t\t\t\t"+"throw new Error(errMessage);\n"+"\t\t\t"+"}\n",a+="\t\t\tbreak;\n"}a+="\t\tdefault:\n",a+="\t\t\tthrow new Error('UNKNOWN KEY ' + key);\n",a+="\t\t\tbreak;\n",a+="\t}\n",a+="};"}return a},b.prototype._escapes=null,b.prototype._templateHandlers=null,b.prototype._input=null,b.prototype._output=null,b.prototype._analyzer=null,b.prototype._knownTags={html:"Html",head:"Head",link:"Link",title:"Title",meta:"Meta",base:"Base",isindex:"IsIndex",style:"Style",body:"Body",form:"Form",select:"Select",optgroup:"OptGroup",option:"Option",input:"Input",textarea:"TextArea",button:"Button",label:"Label",fieldset:"FieldSet",legend:"Legend",ul:"UList",ol:"OList",dl:"DList",directory:"Directory",menu:"Menu",li:"LI",div:"Div",p:"Paragraph",heading:"Heading",q:"Quote",pre:"Pre",br:"BR",basefont:"BaseFont",font:"Font",hr:"HR",mod:"Mod",anchor:"Anchor",image:"Image",object:"Object",param:"Param",applet:"Applet",map:"Map",area:"Area",script:"Script",table:"Table",caption:"TableCaption",col:"TableCol",tr:"TableRow",td:"TableCell",frameset:"FrameSet",frame:"Frame",iframe:"IFrame"},b.prototype._unescape=function(a){return a.replace(/\\(\\|'|r|n|t|u2028|u2029)/g,function(a,b){return this._escapes[b]}.bind(this))},b.prototype._getNNN=function(a){function b(a){return a.charAt(0).toUpperCase()+a.slice(1)}var c=/^(.*)\.[^\.]+$/.exec(a)[1],d=b(/\.([^\.]+)$/.exec(a)[1]);return{inName:c+"."+d+"In",outName:c+"."+d+"Out",template:c+"."+d}},b.prototype._replaceEscaper=function(a){return"\\"+this._escapes[a]},b.prototype._replaceTypedef=function(a,b){return this._analyzer.parse(b),""},b.prototype._replaceInterpolate=function(a,b){return this._analyzer.extract(b),"'+\n("+this._unescape(b)+")+\n'"},b.prototype._replaceEscape=function(b,c){return this._analyzer.extract(c),"'+\n "+a+"escape("+this._unescape(c)+")+\n'"},b.prototype._replacePartial=function(a,b){return this._analyzer.extract(b),this.__replaceInclude(b,"partial")},b.prototype._replaceComponent=function(a,b){return this._analyzer.extract(b),this.__replaceInclude(b,"component")},b.prototype._replaceExport=function(a,b,c,d){var e=/\[\]$/;b=b.toLowerCase();var f=e.test(d),g="HTML"+(b in this._knownTags?this._knownTags[b]:"")+"Element";return f&&(d=d.replace(e,""),g="Array.<"+g+">"),this._output.addVariable(d,g),a.replace(/\{\{@([\s\S]+?)\}\}/g,"$1")},b.prototype._replaceEvaluate=function(a,b){return this._analyzer.extract(b,!0),"';\n"+this._unescape(b)+"\n;__p+='"},b.prototype.__replaceInclude=function(b,c){b=this._unescape(b);var d,e,f,g=!1,h,i=b.split(",");if(i.length>2){var j=/^\s*([a-z][a-z0-9\.]*)\s*,([\s\S]*),\s*([a-z][a-z0-9\.]*)(\[\])?\s*$/i,k;(k=j.exec(b))?(d=k[1],e=k[2],f=k[3],k[4]&&(g=!0)):(j=/^\s*([a-z][a-z0-9\.]*)\s*,([\s\S]*)$/i,k=j.exec(b),d=k[1],e=k[2],f="__null__")}else d=i[0].replace(/^\s+/,"").replace(/\s+$/,""),e=i[1]?i[1]:"false",f="__null__";return c==="partial"?h=this._getNNN(d).outName:h=d,g&&(h="Array.<"+h+">"),this._output.addVariable(f,h),b=""+d+", "+e+', "'+f+'"',"'+\n "+a+"include('"+c+"', "+b+", templatesData)+\n'"},b.prototype._clearHolders=function(){this._input.clear(),this._output.clear(),this._analyzer.clear()};var c=function(){this._variables={}};c.prototype.addVariable=function(a,b){this._variables[a]=b},c.prototype.getVariables=function(){return this._variables},c.prototype.hasVariables=function(){for(var a in this._variables)if(this._variables.hasOwnProperty(a))return!0;return!1},c.prototype.getType=function(a){return this._variables[a]||null},c.prototype.getTypedef=function(){var a="";if(this.hasVariables()){var b=[];for(var c in this._variables)if(this._variables.hasOwnProperty(c)){var d=this._variables[c];b.push(c+": "+d)}a="{\n    "+b.join(",\n    ")+"\n}"}return a},c.prototype.clear=function(){this._variables={}},c.prototype._variables=null;var d=function(a){this._holder=a,this._preTypes={},this._preInputType=""};return d.prototype._holder=null,d.prototype._preTypes=null,d.prototype._preInputType=null,d.prototype.extract=function(a,b){arguments.length<2&&(b=!1);var c=/this\.([a-z_][a-z0-9_]*)(\[[^\]]+\])?([a-z0-9_\.]*)/gi,e;while(e=c.exec(a)){var f=d.VAR_TYPE.string,g=e[1],h=e[2]!==undefined,i=e[3];h?f=d.VAR_TYPE.array:i.length>0?(i=i.slice(1),i==="length"?f=d.VAR_TYPE.array:f=d.VAR_TYPE.object):b&&(f=d.VAR_TYPE.unknown),this._registerVariable(g,f)}},d.prototype.parse=function(a){var b=/^\s*this(\.[a-z_][a-z0-9\.])?\s+([\s\S]+)/i,c;if(c=b.exec(a))if(c[2])if(c[1]){var d=c[1].slice(1);this._preTypes[d]=c[2].replace(/\s+$/,"")}else this._preInputType=c[2].replace(/\s+$/,"")},d.prototype.clear=function(){this._preTypes={},this._preInputType=""},d.prototype.commitPredefined=function(){for(var a in this._preTypes)if(this._preTypes.hasOwnProperty(a)){var b=this._preTypes[a];this._holder.addVariable(a,b)}},d.prototype.getInputType=function(){return this._preInputType},d.prototype._registerVariable=function(a,b){var c=this._holder.getType(a);if(c!==null)switch(b){case d.VAR_TYPE.string:c===d.VAR_TYPE.unknown?this._holder.addVariable(a,d.VAR_TYPE.string):c!==d.VAR_TYPE.string&&this._holder.addVariable(a,d.VAR_TYPE.unknown);break;case d.VAR_TYPE.array:c!==d.VAR_TYPE.array&&c!==d.VAR_TYPE.string&&this._holder.addVariable(a,d.VAR_TYPE.unknown);break;case d.VAR_TYPE.object:c!==d.VAR_TYPE.object&&c!==d.VAR_TYPE.string&&this._holder.addVariable(a,d.VAR_TYPE.unknown);break;case d.VAR_TYPE.unknown:c!==d.VAR_TYPE.string&&this._holder.addVariable(a,d.VAR_TYPE.unknown);break;default:}else this._holder.addVariable(a,b)},d.VAR_TYPE={string:"string",array:"Array",object:"Object",unknown:"*"},b}(),cuteJS.include=function(a,b,c,d,e){return cuteJS._id++,d=d||"__null__",e[cuteJS._id]=[b,c,d],"<!--"+a+cuteJS._id+"-->"},cuteJS.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},cuteJS.buildResult=function a(a,b,c,d){d=d||{};var e=document.createElement("div");e.innerHTML=a;var f=document.createDocumentFragment();while(e.firstChild)f.appendChild(e.firstChild);var g={},h=f,i=/^(partial|component)(\d+)$/;while(h){var j=cuteJS._getNextNode(h);if(h.nodeType===Node.COMMENT_NODE&&i.test(h.nodeValue)){var k=i.exec(h.nodeValue),l=k[1],m=k[2],n=b[m],o=n[0],p=n[1],q=n[2],r,s;if(l==="partial")p?r=o(p,d):r=o(d),s=r.root,r.root=null;else{var t=o;r=new t(p),d.beforeAppendComponent&&d.beforeAppendComponent(r),s=r.getContainer()}var u=s.lastChild;h.parentNode.insertBefore(s,h),l==="component"&&d.afterAppendComponent&&d.afterAppendComponent(r),h.parentNode.removeChild(h),h=u,q!=="__null__"&&c(r,q,g),delete b[m]}h=j}var v=f.querySelectorAll("[data-export-id]"),w=v.length,x,y;while(w--)y=v[w],x=y.getAttribute("data-export-id"),y.removeAttribute("data-export-id"),c(y,x,g);return c(f,"root",g),g},cuteJS._getNextNode=function(a){var b=null;if(a.firstChild)b=a.firstChild;else if(a.nextSibling)b=a.nextSibling;else if(a.parentNode){b=a;while(b&&b.parentNode&&!b.parentNode.nextSibling)b=b.parentNode;b&&b.parentNode&&b.parentNode.nextSibling?b=b.parentNode.nextSibling:b=null}return b},cuteJS._id=0,cuteJS.ComponentInterface=function(){},cuteJS.ComponentInterface.prototype.getContainer=function(){},cuteJS.TemplateOptions=null,typeof exports!="undefined"&&(typeof module!="undefined"&&module.exports&&(exports=module.exports=cuteJS.Engine),exports.TemplateEngine=cuteJS.Engine);